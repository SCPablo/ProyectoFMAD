---
title: "Proyecto FMAD"
subtitle: ICAI. Máster en Big Data. Fundamentos Matemáticos del Análisis de Datos
  (FMAD).
date: 'Curso 2021-22. Última actualización: `r format(Sys.time(), "%Y-%m-%d")`'
linestretch: "1.25"
header-includes:
  \usepackage[spanish]{babel}
output:
  pdf_document: default
  html_document: default
---

\begin{center}
\includegraphics{logoicai.png}
\end{center}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\newpage
\tableofcontents
\newpage


# Introducción

Cargamos las librerías
```{r, echo = FALSE, warning=FALSE,message=FALSE}
library(tidyverse)
library(lubridate)
```

Leemos los datos
```{r}
datos <- read.csv("marketing_campaign.csv", header = TRUE, sep = "")
head(datos)
sum(is.na(datos))
datos<-na.omit(datos)
```

\newpage

# Definición de las variables

- **ID**: El ID del cliente.

- **Year_Birth:** Año de nacimiento.

- **Education:** Nivel de educación del cliente.

- **Marital_Status:** Estado civil del cliente.

- **Income:** Ingreso familiar anual del cliente.

- **Kidhome:** Número de niños pequeños en casa del cliente.

- **Teenhome:** Número de adolescentes en el hogar del cliente.

- **Dt_Customer:** Fecha de inscripción del cliente en la empresa.

- **Recency:** Número de días desde la última compra.

- **MntWines:** Gasto en productos vitivinícolas en los últimos 2 años.

- **MntGoldProds:** Gasto en productos **"premium"??** en los últimos 2 años.

- **NumDealsPurchases:** Número de compras con uso de descuento.

- **NumWebPurchases:** Número de compras a través de la web.

- **NumCatalogPurchases:** Número de compras usando catalogo.

- **NumWebVisitsMonth:** Visitas por mes a la web.

- **AcceptedCmp1:** 1 si el cliente acepta la oferta en la 1ra campaña, 0 si no lo acepta.

- **AcceptedCmp2:** 1 si el cliente acepta la oferta en la 2nd campaña, 0 si no lo acepta.

- **Complain:** 1 si el cliente se ha quejado en los dos últimos años.

- **Z_CostContact:** Coste de contactar con cliente.

- **Z_Revenue:** Ingresos/Beneficios después de que el cliente acepte la campaña

- **Response:** 1 si el cliente acepta la oferta en la última campaña y 0 si no la acepta.



\newpage

# TODO Resumen de datos
```{r}
cat(cat(cat(cat("El conjunto de datos tiene", nrow(datos)), "filas y"), ncol(datos)), "columnas")
```


\newpage


# TODO Preprocesamiento de los datos

**Antes de todo yo diria que habría que eliminar todos los valores nulos ya que hay bastantes y revisar que los datos estan dentro de su variable ya que en varios casos que he visto hay datos de fechas que estan dentro de una variable de tipo int**

Como había muchos datos hemos obtado por una solución simple para corregir los valores erróneos: eliminar las filas.
Además, sustituimos los valores nulos por 0's. Y cambiamos algún tipo de columna que esté mal
```{r}
datos <- datos %>%
  filter(ID != 0 & ID != 1 & Education != "2n" & Income > 10 & Income != "2")
datos$Teenhome <- as.numeric(datos$Teenhome)
```


En el dataset original en vez de aparecer las edades aparecen los años de nacimiento de los clientes. Para un procesamiento mejor y más útil realizaremos un mutate a la tabla con el fin de generar una nueva columna formada por la edad de los clientes.
```{r}
datos <- datos %>%
  mutate(edad = 2021 - Year_Birth) %>%
  select(-Year_Birth) 
```

Sumaremos el total de niños de cada cliente agrupando las columnas Kidhome y Teenhome
```{r}
datos <- datos %>%
  mutate(totalHijos = Kidhome + Teenhome) %>%
  select(-Kidhome, -Teenhome)
```





En esta sección haría los siguientes cambios para dejar un datasets más simple.
Por un lado cogería las columnas "NumWebPurchases", "NumCatalogPurchases" y "NumStorePurchases" que **indican el lugar por donde se han hecho las ofertas a cada cliente** ||||| **Esas variables no son el numero de compras hechas en cada sitio, en tiendas, por catalogo y por la web** |||| y las sumaría todas en una única columna que indique el número de ofertas totales que ha recibido el cliente.
```{r}
datos <- datos %>%
  rowwise(ID) %>%
  mutate(suma_ofertas = sum(c(NumWebPurchases, NumCatalogPurchases, NumStorePurchases))) %>%
  select(-NumWebPurchases, -NumCatalogPurchases, -NumStorePurchases)
```


Vamos a eliminar las columnas: "AcceptedCmp1", "AcceptedCmp2", "AcceptedCmp3", "AcceptedCmp4" y "AcceptedCmp5" y nos vamos a quedar únicamente con la columna "Response" indica si el cliente aceptó la última oferta.

```{r}
datos <- datos %>%
  select(-c(AcceptedCmp3:AcceptedCmp2))
```




Sumamos las columans: "MntWines", "MntFruits", "MntMeatProducts",  "MntFishProducts",  "MntSweetProducts",  "MntGoldProds" para saber cuánto dinero se ha gastado un cliente en total.
```{r}
datos %>%
  rowwise(ID) %>%
  mutate(Dinero_Gastado = sum(c(MntWines, MntFruits, MntMeatProducts, MntFishProducts, MntSweetProducts)))
```
Agrupamos el estado civil de cada cliente y lo simplificamos para ver si vive solo o en pareja
```{r}
datos <- datos %>%
  mutate(Marital_Status = factor(Marital_Status== "Single" | Marital_Status== "Divorced", levels = c(TRUE, FALSE), labels = c('Single','Not single')))
```


Cambiamos la columna Dt_Customer y establecemos 4 grupos que representan la longevidad del cliente en la empresa
```{r}

datos$Dt_Customer = as.Date(datos$Dt_Customer, "%d-%m-%Y")
fechaMinima = min(datos$Dt_Customer)
datos$Dt_Customer <-  factor(cut_number(as.duration(datos$Dt_Customer-fechaMinima), n = 3), labels = c("Nuevo", "Con Experiencia", "Muy Antiguo"), ordered = TRUE)
```








\newpage

# TODO Visualización de los datos
En este apartado se realizará el análisis mediante gráficas de las variables según su tipo, viendo si siguen una distribución normal y si presentarían outliers entre otros factores.
```{r, warning=FALSE, message=FALSE}
datos$Income <- as.numeric(datos$Income)
datos$Recency <- as.numeric(datos$Recency)
h1 <- ggplot(datos)+
  geom_histogram(aes(x = Income), color = "black", alpha = 0.35)
h2 <- ggplot(datos)+
  geom_histogram(aes(x = Recency ), color = "black", alpha = 0.35)
h3 <- ggplot(datos)+
  geom_histogram(aes(x = MntWines ), color = "black", alpha = 0.35)
h4 <- ggplot(datos)+
  geom_histogram(aes(x = MntFruits ), color = "black", alpha = 0.35)
h5 <- ggplot(datos)+
  geom_histogram(aes(x = MntMeatProducts ), color = "black", alpha = 0.35)
h6 <- ggplot(datos)+
  geom_histogram(aes(x = MntFishProducts ), color = "black", alpha = 0.35)
h7 <- ggplot(datos)+
  geom_histogram(aes(x = MntSweetProducts ), color = "black", alpha = 0.35)
h8 <- ggplot(datos)+
  geom_histogram(aes(x = MntGoldProds ), color = "black", alpha = 0.35)
h9 <- ggplot(datos)+
  geom_histogram(aes(x = NumDealsPurchases ), color = "black", alpha = 0.35)
h10 <- ggplot(datos)+
  geom_histogram(aes(x = NumWebPurchases ), color = "black", alpha = 0.35)
h11 <- ggplot(datos)+
  geom_histogram(aes(x = NumCatalogPurchases ), color = "black", alpha = 0.35)
h12 <- ggplot(datos)+
  geom_histogram(aes(x = NumStorePurchases ), color = "black", alpha = 0.35)
h13 <- ggplot(datos)+
  geom_histogram(aes(x = NumWebVisitsMonth ), color = "black", alpha = 0.35)
h14 <- ggplot(datos)+
  geom_histogram(aes(x = Complain ), color = "black", alpha = 0.35)
h15 <- ggplot(datos)+
  geom_histogram(aes(x = edad ), color = "black", alpha = 0.35)
gridExtra::grid.arrange(h1,h2,h3,h4,h5,h6,h7,h8,h9,h10,h11,h12,h13,h14,h15)

```





# TODO Buscar la relación posible entre distintas variable

\newpage
En esta sección usaremos técnicas de Machine Learning tomando distintos outputs. En primera instancia, el output será la variable 'complain' la convertiremos en una variable binaria
```{r}
datos_ML<-datos %>%
  mutate(Complain = factor(Complain>0, levels = c(TRUE, FALSE), labels = c(1,0)))
```

Veamos como se relacionan las diferentes variables con la variable 'complain'.


```{r}
ggplot(datos_ML) + 
  geom_boxplot(aes(x = Complain, y = Income))
```

```{r}
ggplot(datos_ML) + 
  geom_boxplot(aes(x = Complain, y = edad))
```

```{r}
ggplot(datos_ML) + 
  geom_boxplot(aes(x = Complain, y = Niños))
```

```{r}
ggplot(datos_ML) + 
  geom_boxplot(aes(x = Complain, y = ))
```

# TODO Realizar algún modelo predictivo sobre variables target como el 'complain' 


Idea: Alomejor ya es un poco de machine learning pero se me ocurre tratar de encontrar al mejor grupo de personas a las que ofrecerles descuentos para aumentar las ventas. Por ejemplo si ves que la gente con ingresos altos compra independientemente de si tiene descuento o no a ese tipo de gente no mandar descuento pero si se ve que otro grupo aumenta el consumo cuando dispone de descuentos centralizar los descuentos en ese grupo. (Espero que se haya entendido)





# TODO Convertir a booleana la variable target





